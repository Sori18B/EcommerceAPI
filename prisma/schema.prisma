generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  userID           Int      @id @default(autoincrement())
  roleID           Int
  name             String
  lastName         String
  email            String   @unique
  password         String
  phoneNumber      String  @db.VarChar(15) @unique
  imageURL         String?
  stripeCustomerID String? @db.VarChar(255)

  // timestamps
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // relations
  role      Role      @relation(fields: [roleID], references: [roleID])
  addresses Address[]
  favorites Favorite[]
  carts     ShoppingCart[]
  orders    Orders[]
}

enum AddressType {
  BILLING
  SHIPPING
  BOTH
}

model Address {
  // Identificación
  addressID     Int      @id @default(autoincrement())
  userID        Int
  addressType   AddressType @default(BOTH)

  // Datos personales en la dirección
  firstName     String   @db.VarChar(100)
  lastName      String   @db.VarChar(100)

  // Dirección física (REQUERIDOS por Stripe)
  street        String   @db.VarChar(255)
  neighborhood  String?  @db.VarChar(100)  // ← OPCIONAL
  city          String   @db.VarChar(100)
  state         String   @db.VarChar(100)
  postalCode    String   @db.VarChar(20)
  countryCode   String   @db.VarChar(2)    // ← ISO 2 caracteres

  // Flags de uso
  isBillingDefault  Boolean @default(false)
  isShippingDefault Boolean @default(false)

  // Timestamps
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // relations
  user              User     @relation(fields: [userID], references: [userID])
  ordersAsShipping  Orders[] @relation("ShippingAddress")
  ordersAsBilling   Orders[] @relation("BillingAddress")

  // Índice para performance
  @@index([userID])
}

model Role {
  roleID    Int     @id @default(autoincrement())
  roleName  String  @unique @db.VarChar(50)

  // back-relation
  users User[]
}

model Product {
  productID   Int       @id @default(autoincrement())
  name        String    @db.VarChar(255)
  description String    @db.Text
  basePrice   Decimal   @db.Decimal(10, 2)
  isActive    Boolean   @default(true)
  //Stripe fields
  stripeProductId   String?  @unique @db.VarChar(255)
  taxCode          String?  @db.VarChar(50)
  shippable        Boolean? @default(true)   


  // FK
  categoryID  Int
  genderID    Int

  // timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // relations
  category    Category  @relation(fields: [categoryID], references: [categoryID], onDelete: Restrict, onUpdate: Cascade)
  gender      Gender    @relation(fields: [genderID], references: [genderID], onDelete: Restrict, onUpdate: Cascade)
  images      ProductImage[]
  variants    ProductVariant[]
  favorites   Favorite[]

  // indices para catálogo
  @@index([categoryID])
  @@index([genderID])
  @@index([isActive])
}

model Category {
  categoryID   Int      @id @default(autoincrement())
  categoryName String   @unique @db.VarChar(255)
  description  String?  @db.Text
  isActive     Boolean  @default(true)

  // back-relation
  products     Product[]
}

model Gender {
  genderID   Int     @id @default(autoincrement())
  genderName String  @unique @db.VarChar(50)

  // back-relation
  products   Product[]
}

model ProductImage {
  imageID      Int      @id @default(autoincrement())
  productID    Int
  imageURL     String   @db.VarChar(2048)
  altText      String?  @db.VarChar(255)
  displayOrder Int      @default(0)
  isMain       Boolean  @default(false)

  // timestamps (opcional)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // relation
  product      Product  @relation(fields: [productID], references: [productID], onDelete: Cascade, onUpdate: Cascade)

  @@unique([productID, displayOrder])
  @@index([productID])
}

model ProductVariant {
  productVariantID Int      @id @default(autoincrement())
  productID        Int
  sizeID           Int
  colorID          Int
  sku              String   @unique @db.VarChar(100)
  price            Decimal  @db.Decimal(10, 2)
  stock            Int      @default(0)
  isActive         Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  //Stripe fields
  stripePriceId    String?  @unique @db.VarChar(255)
  currency         String   @default("mxn") @db.VarChar(3)
  mode             PaymentMode? @default(payment)  // 'payment' | 'subscription' | 'setup'
  taxBehavior      TaxBehavior? @default(unspecified)
  nickname         String?  @db.VarChar(255)

  // relations
  product          Product  @relation(fields: [productID], references: [productID], onDelete: Cascade, onUpdate: Cascade)
  size             Size     @relation(fields: [sizeID], references: [sizeID], onDelete: Restrict, onUpdate: Cascade)
  color            Color    @relation(fields: [colorID], references: [colorID], onDelete: Restrict, onUpdate: Cascade)
  cartItems        ShoppingCartItem[]
  orderDetails     OrderDetails[]

  @@unique([productID, sizeID, colorID])
  @@index([productID])
  @@index([sizeID])
  @@index([colorID])
}

enum PaymentMode {
  payment
  subscription
  setup
}

enum TaxBehavior {
  inclusive
  exclusive
  unspecified
}

model Size {
  sizeID    Int     @id @default(autoincrement())
  sizeLabel String  @unique @db.VarChar(100)
  sizeOrder Int     @default(0)

  // back-relation
  variants  ProductVariant[]
}

model Color {
  colorID   Int     @id @default(autoincrement())
  colorName String  @unique @db.VarChar(100)
  hexCode   String? @db.VarChar(7) // #4242aaff

  // back-relation
  variants  ProductVariant[]
}

model Favorite {
  favoriteID Int      @id @default(autoincrement())
  userID     Int
  productID  Int
  addedAt    DateTime @default(now())

  // relations
  user       User     @relation(fields: [userID], references: [userID], onDelete: Cascade, onUpdate: Cascade)
  product    Product  @relation(fields: [productID], references: [productID], onDelete: Cascade, onUpdate: Cascade)

  @@unique([userID, productID])

  @@index([userID])
  @@index([productID])
}

model ShoppingCart {
  cartID     Int      @id @default(autoincrement())
  userID     Int      @unique
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // relations
  user       User     @relation(fields: [userID], references: [userID], onDelete: Cascade, onUpdate: Cascade)
  items      ShoppingCartItem[]

  @@index([userID])
}

model ShoppingCartItem {
  cartItemID        Int      @id @default(autoincrement())
  cartID            Int
  productVariantID  Int
  quantity          Int      @default(1)
  addedAt           DateTime @default(now())

  // relations
  cart              ShoppingCart    @relation(fields: [cartID], references: [cartID], onDelete: Cascade, onUpdate: Cascade)
  productVariant    ProductVariant  @relation(fields: [productVariantID], references: [productVariantID], onDelete: Cascade, onUpdate: Cascade)

  @@unique([cartID, productVariantID])
  @@index([cartID])
  @@index([productVariantID])
}

model Orders{
  orderID        Int      @id @default(autoincrement())
  userID         Int
  shippingAddressID Int
  billingAddressID  Int
  orderDate      DateTime @default(now())
  estimatedDeliveryDate DateTime?
  actualDeliveryDate    DateTime?
  orderStatus   String   @db.VarChar(50)
  deliveryStatusID Int?
  subtotalAmount  Decimal  @db.Decimal(10, 2)
  taxAmount      Decimal  @db.Decimal(10, 2)
  shippingAmount Decimal  @db.Decimal(10, 2)
  totalAmount    Decimal  @db.Decimal(10, 2)
  currency      String   @default("mxn") @db.VarChar(3)
  stripePaymentIntentID String? @db.VarChar(255)
  stripeSessionID String? @db.VarChar(255)
  paymentMethod String   @db.VarChar(50)
  paymentStatusID Int?
  paidAt       DateTime?
  customerNote String?  @db.Text
  adminNote    String?  @db.Text
  trackingNumber String? @db.VarChar(100)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // relations
  user              User            @relation(fields: [userID], references: [userID], onDelete: Restrict, onUpdate: Cascade)
  shippingAddress   Address         @relation("ShippingAddress", fields: [shippingAddressID], references: [addressID], onDelete: Restrict, onUpdate: Cascade)
  billingAddress    Address         @relation("BillingAddress", fields: [billingAddressID], references: [addressID], onDelete: Restrict, onUpdate: Cascade)
  deliveryStatus    DeliveryStatus? @relation(fields: [deliveryStatusID], references: [deliveryStatusID], onDelete: SetNull, onUpdate: Cascade)
  paymentStatus     PaymentStatus?  @relation(fields: [paymentStatusID], references: [paymentStatusID], onDelete: SetNull, onUpdate: Cascade)
  orderDetails      OrderDetails[]

  @@index([userID])
  @@index([shippingAddressID])
  @@index([billingAddressID])
  @@index([deliveryStatusID])
  @@index([paymentStatusID])
  @@index([orderDate])
}

model OrderDetails{
  orderDetailID   Int      @id @default(autoincrement())
  orderID         Int
  productVariantID Int
  productName    String   @db.VarChar(255)
  variantSKU    String   @db.VarChar(100)
  priceAtPurchase  Decimal  @db.Decimal(10, 2)
  quantity        Int      @default(1)
  subtotal       Decimal  @db.Decimal(10, 2)
  discountAmount Decimal  @db.Decimal(10, 2) @default(0)
  discountType   String?  @db.VarChar(50)
  discountCode   String?  @db.VarChar(50)
  unitPrice      Decimal  @db.Decimal(10, 2)
  totalPrice     Decimal  @db.Decimal(10, 2)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // relations
  order            Orders          @relation(fields: [orderID], references: [orderID], onDelete: Cascade, onUpdate: Cascade)
  productVariant   ProductVariant  @relation(fields: [productVariantID], references: [productVariantID], onDelete: Restrict, onUpdate: Cascade)

  @@index([orderID])
  @@index([productVariantID])
}

model DeliveryStatus {
  deliveryStatusID Int     @id @default(autoincrement())
  statusName      String  @unique @db.VarChar(50)
  description     String? @db.Text
  
  // relations
  orders          Orders[]
}

model PaymentStatus {
  paymentStatusID Int     @id @default(autoincrement())
  statusName      String  @unique @db.VarChar(50)
  description     String? @db.Text
  
  // relations
  orders          Orders[]
}

model StripeWebhookLog {
  webhookID        Int      @id @default(autoincrement())
  eventID          String   @unique @db.VarChar(255)
  eventType        String   @db.VarChar(255)
  status           String   @db.VarChar(50)
  processed        Boolean  @default(false)
  processedAt      DateTime?
  retryCount       Int      @default(0)
  errorMessage     String?  @db.Text
  payload          Json
  receivedAt       DateTime @default(now())
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([eventID])
  @@index([eventType])
  @@index([status])
  @@index([processed])
  @@index([receivedAt])
}

model DiscountCoupons{
  couponID            Int      @id @default(autoincrement())
  code                String   @unique @db.VarChar(50)
  description         String?  @db.Text
  discountType        String   @db.VarChar(50)
  discountValue       Decimal  @db.Decimal(10, 2)
  minOrderAmount      Decimal  @db.Decimal(10, 2) @default(0)
  maxUsageLimit       Int?
  maxUsagePerUser     Int?     @default(1)
  currentUsageCount   Int      @default(0)
  validFrom           DateTime
  validUntil          DateTime
  isActive            Boolean  @default(true)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  // relations
  @@index([code])
  @@index([isActive])
  @@index([validFrom, validUntil])
}